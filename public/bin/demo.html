<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>mydb WASM Minimal Demo</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; }
    textarea { width: 100%; box-sizing: border-box; }
    pre { background:#111; color:#eee; padding:12px; min-height:120px; white-space:pre-wrap; }
    button { padding:8px 12px; margin-top:8px; }
  </style>
</head>
<body>
  <h1>mydb WASM Minimal Demo</h1>
  <label for="sql">SQL:</label>
  <textarea id="sql" rows="4">select * from images</textarea>
  <div>
    <button id="exec" disabled>Execute</button>
  </div>
  <h3>Output</h3>
  <pre id="out">(no output)</pre>

  <script src="./mydb.js"></script>
  <script>
    const execBtn = document.getElementById('exec');
    const sqlEl = document.getElementById('sql');
    const outEl = document.getElementById('out');

    function ensurePersistent(Module) {
      return new Promise((resolve, reject) => {
        try { Module.FS.mkdir('/persistent'); } catch (e) {}
        try { Module.FS.mount(Module.IDBFS || IDBFS, {}, '/persistent'); } catch (e) {
          console.warn('mount IDBFS failed (may be already mounted)', e);
        }
        Module.FS.syncfs(true, function(err) {
          if (err) {
            console.error('FS.syncfs(true) error', err);
            reject(err);
          } else {
            console.log('IDBFS -> MEMFS sync complete');
            resolve();
          }
        });
      });
    }

    function allocString(Module, str) {
      if (Module.allocateUTF8) return Module.allocateUTF8(str);
      var len = (Module.lengthBytesUTF8 ? Module.lengthBytesUTF8(str) : (new TextEncoder().encode(str).length)) + 1;
      var ptr = Module._malloc(len);
      if (!ptr) throw new Error('allocString: malloc failed');
      if (Module.stringToUTF8) {
        Module.stringToUTF8(str, ptr, len);
        return ptr;
      }
      if (Module.HEAPU8) {
        var encoder = new TextEncoder();
        var bytes = encoder.encode(str);
        Module.HEAPU8.set(bytes, ptr);
        Module.HEAPU8[ptr + bytes.length] = 0;
        return ptr;
      }
      Module._free(ptr);
      throw new Error('allocString: no method to write string into wasm memory');
    }

    // Use the modularized export `MyDB()` which returns a Promise
    MyDB().then(Module => {
      ensurePersistent(Module).then(() => {
        const mydb_open = Module.cwrap('mydb_open_with_ems', 'number', ['string']);
        const mydb_execute_json = Module.cwrap('mydb_execute_json_with_ems', 'number', ['number','number','number']);

        const handle = mydb_open('test2.db');
        if (!handle) {
          outEl.textContent = 'Failed to open DB handle';
          return;
        }

        execBtn.disabled = false;

        execBtn.addEventListener('click', () => {
          try {
            const sql = sqlEl.value;
            const sqlPtr = allocString(Module, sql);
            const outPtrPtr = Module._malloc(4);
            try {
              const rc = mydb_execute_json(handle, sqlPtr, outPtrPtr);
              const outPtr = Module.getValue(outPtrPtr, 'i32');
              let text = null;
              if (outPtr) {
                text = Module.UTF8ToString(outPtr);
                Module._free(outPtr);
              }
              outEl.textContent = text || '(null)';
            } finally {
              Module._free(outPtrPtr);
              Module._free(sqlPtr);
            }

            // Persist any changes under /persistent to IndexedDB
            try {
              Module.FS.syncfs(false, function(err) {
                if (err) console.error('Failed to persist DB to IDBFS:', err);
                else console.log('Persisted /persistent -> IDBFS');
              });
            } catch (e) {
              console.error('DB persist error:', e);
            }

          } catch (err) {
            outEl.textContent = 'Error: ' + err;
          }
        });
      }).catch(err => {
        console.error('Failed to initialize persistent FS', err);
        outEl.textContent = 'Module init error: ' + err;
      });
    }).catch(err => { outEl.textContent = 'Module load error: ' + err; });
  </script>
</body>
</html>


/**

emcc db.c sql_lexer.c sql_parser.c -o /Users/baiyangmu333/Projects/db_learn/db_tutorial-master/src/bin/mydb.js \
  -O2 \
  -s MODULARIZE=1 \
  -s EXPORT_NAME='MyDB' \
  -s EXPORTED_FUNCTIONS='["_mydb_open_with_ems","_mydb_close_with_ems","_mydb_execute_json_with_ems","_mydb_open","_mydb_close","_mydb_execute_json","_malloc","_free"]' \
  -s EXPORTED_RUNTIME_METHODS='["cwrap","ccall","UTF8ToString","stringToUTF8","lengthBytesUTF8","getValue","setValue","FS","IDBFS","allocateUTF8","HEAPU8","writeArrayToMemory"]' \
  -s ALLOW_MEMORY_GROWTH=1 \
  -s FORCE_FILESYSTEM=1 \
  -s ENVIRONMENT='web' \
  -lidbfs.js
*/